<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- 加入 viewport-fit=cover 與 user-scalable=no 以適應全面屏手機並禁止縮放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- iOS PWA 相關設置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>飛天神駒 PRO - FURY EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Noto+Sans+TC:wght@500;900&display=swap');

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed; /* 鎖定視口 */
            overflow: hidden;
            background-color: #000; 
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            /* 寬度固定 900，高度由 JS 動態決定 */
            width: 900px;  
            height: 1600px; /* 預設高度 */
            background-color: #1a1a2e;
            overflow: hidden;
            opacity: 0; 
            transition: opacity 0.5s;
            /* 預設左上角，resize 會動態調整 */
            transform-origin: 0 0;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .ui-font {
            font-family: 'Black Ops One', cursive;
            letter-spacing: 1px;
        }
        
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }
        
        .pointer-events-auto {
            pointer-events: auto;
        }
        
        /* 按鈕樣式優化 */
        .neon-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.1s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .neon-btn:active {
            transform: scale(0.92);
        }
        .neon-btn::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }
        .neon-btn:hover::after {
            left: 100%;
        }

        .shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .control-panel {
            background: linear-gradient(to top, rgba(0,0,0,0.95) 10%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0) 100%);
            padding-bottom: max(2rem, env(safe-area-inset-bottom)); 
            padding-top: 6rem;
        }
        
        /* 掃光動畫 */
        @keyframes slide {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* CD ICON 動畫 */
        .cd-overlay {
            transition: height 0.1s linear;
        }

        /* 路途滾動條樣式 */
        .roadmap-item {
            transition: all 0.3s ease-out;
        }
        
        /* 處理中狀態 */
        .processing {
            filter: brightness(0.5);
            pointer-events: none;
        }

        /* 底版閃爍動畫 */
        @keyframes flash-pulse {
            0%, 100% { opacity: 0.8; transform: scale(1) skewX(-12deg); }
            50% { opacity: 1; transform: scale(1.05) skewX(-12deg); }
        }
        .animate-flash {
            animation: flash-pulse 0.5s infinite;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer safe-area-inset">
        <!-- 頂部區域容器 (包含 HUD 和 Roadmap) -->
        <div class="flex flex-col w-full relative z-20 pt-8 pointer-events-none">
            
            <!-- 路途 (Roadmap) -->
            <div class="w-full flex justify-center items-center mb-2 overflow-hidden px-4">
                <div class="bg-black/60 backdrop-blur-sm rounded-full px-5 py-3 border border-white/10 flex items-center gap-3 shadow-lg max-w-[98%]">
                    <span class="text-xs text-gray-400 font-bold uppercase mr-1 tracking-wider">HISTORY</span>
                    <!-- 過去 -->
                    <div id="roadmapPast" class="flex gap-2 opacity-60 scale-90 origin-right">
                        <!-- JS 填充 -->
                    </div>
                    
                    <div class="w-[1px] h-8 bg-white/30 mx-1"></div>
                    
                    <!-- 未來 -->
                    <div id="roadmapFuture" class="flex gap-2 items-center">
                        <!-- JS 填充 -->
                    </div>
                    <span class="text-xs text-blue-400 font-bold uppercase ml-1 tracking-wider">UPCOMING</span>
                </div>
            </div>

            <!-- HUD -->
            <div class="flex justify-between items-start px-6"> 
                <div class="bg-black/70 backdrop-blur-md px-6 py-4 rounded-3xl border-l-8 border-yellow-500 shadow-xl transform scale-90 origin-top-left">
                    <div class="text-sm text-yellow-300 font-bold tracking-wider uppercase opacity-80">Balance</div>
                    <div class="text-4xl text-white ui-font text-shadow tracking-tight" id="balanceDisplay">$5,000.00</div>
                </div>
                
                <div class="bg-black/70 backdrop-blur-md px-6 py-4 rounded-3xl border-r-8 border-blue-500 shadow-xl transform scale-90 origin-top-right min-w-[120px] text-right">
                    <!-- 1. 給 Bonus 標籤加 ID 方便控制 -->
                    <div class="text-sm text-blue-300 font-bold tracking-wider uppercase opacity-80" id="bonusLabel">NEXT TARGET</div>
                    <div class="text-5xl text-blue-400 ui-font" id="multiplierDisplay">x1</div>
                </div>
            </div>
        </div>
        
        <!-- 天空飛行計時條 -->
        <div id="skyHUD" class="absolute top-[200px] left-1/2 transform -translate-x-1/2 w-[80%] max-w-[600px] pointer-events-none opacity-0 transition-opacity duration-500 z-10">
            <div class="relative">
                <div class="absolute inset-0 bg-pink-500 blur-md opacity-30 rounded-full"></div>
                <div class="w-full h-8 bg-gray-900/90 rounded-full overflow-hidden border-2 border-pink-400/50 shadow-[0_0_20px_rgba(0,0,0,0.8)] flex items-center p-1">
                    <div id="skyTimerBar" class="h-full rounded-full bg-gradient-to-r from-pink-500 via-purple-400 to-white w-full shadow-[0_0_15px_rgba(236,72,153,0.8)] transition-all duration-[16ms] ease-linear relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHBhdGggZD0iTTEwIDAgTDAgMjAgTDEwIDIwIEwyMCAwIFoiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4yKSIvPjwvc3ZnPg==')] opacity-30 animate-[slide_1s_linear_infinite]"></div>
                    </div>
                </div>
                <div class="absolute -top-7 left-1/2 -translate-x-1/2 w-full text-center">
                    <span class="text-pink-200 text-lg font-bold drop-shadow-md tracking-[0.2em] ui-font">PINATA TIME</span>
                </div>
            </div>
        </div>

        <!-- 中央醒目提示框 (戰術 HUD) -->
        <div id="centerHUD" class="absolute top-[35%] left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none transition-opacity duration-200 opacity-0 flex flex-col items-center justify-center">
            <!-- 閃爍底版 -->
            <div id="centerAlertBg" class="absolute inset-0 rounded-xl transform -skew-x-12 shadow-[0_0_30px_rgba(0,0,0,0.5)]"></div>
            <!-- 內容 -->
            <div class="relative px-12 py-5 flex flex-col items-center z-10">
                <span id="centerAlertIcon" class="text-6xl mb-2 drop-shadow-md filter grayscale-0"></span>
                <span id="centerAlertText" class="text-5xl font-black ui-font text-white drop-shadow-[0_4px_0_#000] tracking-widest italic whitespace-nowrap"></span>
            </div>
        </div>
        
        <!-- 左輪彈夾冷卻指示器 -->
        <div id="hitCooldownUI" class="absolute bottom-40 right-6 pointer-events-none opacity-0 transition-opacity duration-300 z-20 flex flex-col items-center scale-110">
            <div class="relative w-32 h-32">
                <!-- 彈夾主體 -->
                <div class="absolute inset-0 rounded-full bg-gray-900 border-[6px] border-gray-600 shadow-2xl overflow-hidden">
                    <!-- 背景裝飾 -->
                    <div class="absolute inset-0 rounded-full border-[20px] border-gray-800 opacity-50"></div>
                    
                    <!-- 彈巢容器 (旋轉部分) -->
                    <div id="revolverContainer" class="absolute inset-0 w-full h-full transition-transform duration-100 ease-out origin-center">
                        <!-- 子彈將由 JS 生成 -->
                    </div>
                    
                    <!-- 中心軸 -->
                    <div class="absolute top-1/2 left-1/2 w-14 h-14 bg-gray-800 rounded-full -translate-x-1/2 -translate-y-1/2 border-4 border-gray-600 z-20 grid place-items-center shadow-inner">
                        <span id="ammoText" class="text-xs font-black text-gray-400 leading-tight text-center ui-font">RDY</span>
                    </div>
                </div>
            </div>
            <span class="mt-3 text-yellow-400 font-bold text-sm bg-black/50 px-3 py-1 rounded-full border border-yellow-400/30">BURST FIRE</span>
        </div>

        <!-- 底部控制區 -->
        <div class="control-panel flex flex-col items-center justify-end w-full">
            
            <div id="groundControls" class="mb-4 pointer-events-none transition-opacity duration-300">
                <div id="startHint" class="text-white text-2xl font-black bg-gradient-to-r from-green-600 to-teal-600 px-8 py-3 rounded-full animate-bounce shadow-lg border-2 border-white/20 tracking-wider">
                    TAP ANYWHERE TO START
                </div>
            </div>

            <!-- 下注操作區 -->
            <div id="betPanel" class="pointer-events-auto flex flex-col items-center w-full max-w-[900px] px-6 transition-opacity duration-200">
                <div class="flex items-baseline gap-2 mb-3 bg-black/60 px-6 py-2 rounded-full border border-white/10">
                    <span class="text-gray-400 text-sm font-bold uppercase">CLIP COST</span>
                    <span id="currentBetDisplay" class="ui-font text-3xl text-yellow-400 drop-shadow-md">$10.00</span>
                </div>
                
                <div class="grid grid-cols-5 gap-2 w-full max-w-xl">
                    <button onclick="game.setBet(1)" class="neon-btn aspect-square rounded-2xl bg-gray-800 border-2 border-gray-600 text-white font-bold flex flex-col items-center justify-center hover:bg-gray-700 hover:border-emerald-400 active:bg-gray-900 shadow-lg group">
                        <div class="w-5 h-5 rounded-full bg-emerald-400 mb-1 shadow-[0_0_10px_#34d399] group-hover:scale-110 transition-transform"></div>
                        <span class="ui-font text-lg">1</span>
                    </button>
                    <button onclick="game.setBet(10)" class="neon-btn aspect-square rounded-2xl bg-gray-800 border-2 border-gray-600 text-white font-bold flex flex-col items-center justify-center hover:bg-gray-700 hover:border-yellow-400 active:bg-gray-900 shadow-lg group">
                        <div class="w-6 h-6 rounded-full bg-yellow-500 mb-1 shadow-[0_0_10px_#eab308] group-hover:scale-110 transition-transform"></div>
                        <span class="ui-font text-lg">10</span>
                    </button>
                    <button onclick="game.setBet(50)" class="neon-btn aspect-square rounded-2xl bg-gray-800 border-2 border-gray-600 text-white font-bold flex flex-col items-center justify-center hover:bg-gray-700 hover:border-blue-400 active:bg-gray-900 shadow-lg group">
                         <div class="w-7 h-7 rounded-full bg-blue-500 mb-1 shadow-[0_0_10px_#3b82f6] group-hover:scale-110 transition-transform"></div>
                        <span class="ui-font text-xl">50</span>
                    </button>
                    <button onclick="game.setBet(100)" class="neon-btn aspect-square rounded-2xl bg-gray-800 border-2 border-gray-600 text-white font-bold flex flex-col items-center justify-center hover:bg-gray-700 hover:border-red-400 active:bg-gray-900 shadow-lg group">
                        <div class="w-8 h-8 rounded-full bg-red-500 mb-1 shadow-[0_0_10px_#ef4444] group-hover:scale-110 transition-transform"></div>
                        <span class="ui-font text-2xl">100</span>
                    </button>
                    <button onclick="game.setBet(1000)" class="neon-btn aspect-square rounded-2xl bg-gray-800 border-2 border-gray-600 text-white font-bold flex flex-col items-center justify-center hover:bg-gray-700 hover:border-purple-400 active:bg-gray-900 shadow-lg group">
                        <div class="w-9 h-9 rounded-full bg-purple-500 mb-1 shadow-[0_0_10px_#a855f7] group-hover:scale-110 transition-transform border border-white"></div>
                        <span class="ui-font text-xl">1K</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- 音效控制器類別 ---
class AudioController {
    constructor() {
        this.ctx = null;
        this.enabled = false;
        this.bgmTimer = null;
        this.currentBPM = 110; 
        this.targetBPM = 110;
        this.nextNoteTime = 0;
        this.bassLine = [110, 110, 130, 110, 146, 130, 110, 98];
        this.melodyLine = [330, 0, 392, 0, 440, 392, 330, 293]; 
        this.noteIdx = 0;
        this.isSkyMode = false;
    }

    init() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.enabled = true;
            this.startLoop();
        } else if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    }

    playTone(freq, type, duration, vol = 0.1, slideFreq = null) {
        if (!this.enabled || !freq) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        if (slideFreq) {
            osc.frequency.exponentialRampToValueAtTime(slideFreq, this.ctx.currentTime + duration);
        }
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }

    playNoise(duration, vol = 0.1) {
        if (!this.enabled) return;
        const bufferSize = this.ctx.sampleRate * duration;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            data[i] = Math.random() * 2 - 1;
        }
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        noise.connect(gain);
        gain.connect(this.ctx.destination);
        noise.start();
    }

    playJump() {
        this.playTone(150, 'square', 0.1, 0.1, 600); 
    }

    playHit() {
        this.playNoise(0.1, 0.3); 
        this.playTone(100, 'sawtooth', 0.1, 0.2, 50);
    }

    playShoot() {
        this.playNoise(0.05, 0.2);
        this.playTone(200, 'sawtooth', 0.05, 0.2, 50);
    }

    playReload() {
        this.playTone(400, 'sine', 0.1, 0.1, 600);
        setTimeout(() => this.playTone(600, 'sine', 0.1, 0.1, 800), 150);
    }

    playWin() {
        this.playTone(1200, 'sine', 0.1, 0.1);
        setTimeout(() => this.playTone(1800, 'sine', 0.2, 0.1), 50);
    }

    playExplode() {
        this.playNoise(0.8, 0.8); 
        this.playTone(100, 'sawtooth', 0.5, 0.5, 10); 
    }

    setSkyMode(isSky) {
        this.isSkyMode = isSky;
        this.targetBPM = isSky ? 160 : 110; 
    }

    startLoop() {
        if (this.nextNoteTime === 0) this.nextNoteTime = this.ctx.currentTime + 0.1;
        const scheduler = () => {
            if (!this.enabled || this.ctx.state === 'suspended') {
                requestAnimationFrame(scheduler);
                return;
            }
            while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                this.scheduleNote(this.noteIdx, this.nextNoteTime);
                this.noteIdx++;
                this.currentBPM += (this.targetBPM - this.currentBPM) * 0.1;
                const secondsPerBeat = 60.0 / this.currentBPM;
                this.nextNoteTime += secondsPerBeat * 0.5; 
            }
            requestAnimationFrame(scheduler);
        };
        scheduler();
    }

    scheduleNote(idx, time) {
        const bassFreq = this.bassLine[idx % this.bassLine.length];
        const bassType = this.isSkyMode ? 'square' : 'triangle';
        const bassVol = this.isSkyMode ? 0.08 : 0.05;
        this.playToneScheduled(bassFreq, bassType, 0.2, bassVol, time);

        if (this.isSkyMode) {
            const melFreq = this.melodyLine[idx % this.melodyLine.length];
            if (melFreq > 0) {
                this.playToneScheduled(melFreq, 'sawtooth', 0.1, 0.05, time);
                if (Math.random() < 0.2) {
                    this.playToneScheduled(melFreq * 2, 'sine', 0.1, 0.03, time);
                }
            }
        }
    }

    playToneScheduled(freq, type, duration, vol, time) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, time);
        gain.gain.setValueAtTime(vol, time);
        gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start(time);
        osc.stop(time + duration);
    }
}

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.wrapper = document.getElementById('game-wrapper');
        this.audio = new AudioController(); 
        
        this.width = 900; 
        this.height = 1600; 
        
        this.state = 'GROUND'; 
        
        let savedBalance = localStorage.getItem('cp_balance');
        this.balance = savedBalance ? parseFloat(savedBalance) : 5000;
        if (this.balance <= 0) {
            this.balance = 5000;
            this.saveBalance();
        }
        
        this.betAmount = 10;
        this.currentMultiplier = 1;
        
        // 射擊邏輯變數
        this.isFiring = false;
        this.fireQueue = 0; // 待發射子彈數
        this.fireTimer = 0; // 射速控制
        this.pendingResult = null; // 預存的結果

        // 新增：連勝狂暴系統
        this.winStreak = 0;
        this.isFury = false;

        this.camera = { y: 0, shake: 0 };
        this.flashAlpha = 0; 
        this.gameTick = 0;
        this.bgScroll = 0;
        this.groundSpeed = 12; 
        
        this.groundLevel = 0; 
        this.horseBaseY = 0; 

        this.horse = {
            x: 0, y: 0, vy: 0, angle: 0,
            state: 'RUN', 
            spinTimer: 0,
            scale: 2.2,
            targetX: 0, targetY: 0,
            moveTimer: 0,
            pinataHits: 0,    
            wobble: 0,
            animScaleX: 1, 
            animScaleY: 1,
            scaleVx: 0, 
            scaleVy: 0,
            faceTimer: 0,
            tongueOut: 0, 
            buttWiggle: 0 
        };

        this.springs = []; 
        this.springSpawnTimer = 0;
        this.bullets = []; 
        this.particles = [];
        this.texts = [];
        this.clouds = [];

        this.skyDurationMax = 300;
        this.skyTimer = 0;

        this.hitCooldownMax = 60; // 1秒 CD
        this.hitCooldown = 0;

        this.roadmapFuture = [];
        this.roadmapPast = [];
        for(let i=0; i<20; i++) {
            this.roadmapFuture.push(this.generateWeightedMultiplier());
        }

        for(let i=0; i<8; i++) {
            this.clouds.push({
                x: Math.random() * 900,
                y: Math.random() * 800,
                speed: 1 + Math.random() * 2,
                size: 50 + Math.random() * 80,
                alpha: 0.2 + Math.random() * 0.3
            });
        }

        // 初始化左輪彈夾 UI
        this.initRevolverUI();

        window.addEventListener('resize', () => this.resize());
        window.addEventListener('orientationchange', () => setTimeout(() => this.resize(), 100));
        
        try {
            this.audio.init();
        } catch(e) { console.log(e); }
        
        const resumeAudio = () => {
            if (this.audio.ctx && this.audio.ctx.state === 'suspended') {
                this.audio.ctx.resume();
            }
            window.removeEventListener('click', resumeAudio);
            window.removeEventListener('touchstart', resumeAudio);
        };
        window.addEventListener('click', resumeAudio);
        window.addEventListener('touchstart', resumeAudio);

        this.canvas.addEventListener('pointerdown', (e) => this.handleInput(e));
        
        this.resize(); 
        this.updateUI();
        this.updateRoadmapUI(); 
        
        // 修正：鎖定 FPS 為 60
        this.fps = 60;
        this.frameInterval = 1000 / this.fps;
        this.lastFrameTime = 0;
        this.loop(0); // 傳入初始時間
        
        setTimeout(() => {
            this.wrapper.style.opacity = 1;
        }, 100);
    }

    initRevolverUI() {
        const container = document.getElementById('revolverContainer');
        container.innerHTML = '';
        
        for(let i=0; i<6; i++) {
            const angle = i * 60;
            const slot = document.createElement('div');
            slot.className = 'absolute top-0 left-0 w-full h-full pointer-events-none';
            slot.style.transform = `rotate(${angle}deg)`;
            
            slot.innerHTML = `
                <div class="absolute left-1/2 -translate-x-1/2 top-2 w-8 h-8 rounded-full bg-gray-950 border border-gray-700 flex items-center justify-center shadow-inner overflow-hidden">
                    <div id="bullet-slot-${i}" class="w-6 h-6 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-600 shadow-[0_0_5px_rgba(234,179,8,0.8)] scale-100 transition-transform duration-150"></div>
                </div>
            `;
            container.appendChild(slot);
        }
    }

    formatCurrency(value) {
        return '$' + value.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    saveBalance() {
        localStorage.setItem('cp_balance', this.balance);
    }

    generateWeightedMultiplier() {
        const types = [
            { mul: 2, color: '#22c55e', label: 'x2', weight: 400, textColor: '#fff' },
            { mul: 5, color: '#fbbf24', label: 'x5', weight: 300, textColor: '#000' },
            { mul: 10, color: '#f97316', label: 'x10', weight: 150, textColor: '#fff' },
            { mul: 25, color: '#ef4444', label: 'x25', weight: 80, textColor: '#fff' },
            { mul: 50, color: '#db2777', label: 'x50', weight: 40, textColor: '#fff' },
            { mul: 100, color: '#9333ea', label: 'x100', weight: 20, textColor: '#fff', glow: true },
            { mul: 500, color: '#2563eb', label: 'x500', weight: 8, textColor: '#fff', glow: true },
            { mul: 1000, color: '#ffffff', label: 'x1K', weight: 6.0, textColor: '#000', glow: true },
            { mul: 10000, color: '#00ffff', label: 'MAX', weight: 2.0, textColor: '#000', glow: true }
        ];
        
        const totalWeight = types.reduce((sum, t) => sum + t.weight, 0);
        let rand = Math.random() * totalWeight;
        let selected = types[0];
        
        for(let t of types) {
            if(rand < t.weight) {
                selected = t;
                break;
            }
            rand -= t.weight;
        }
        return selected;
    }

    // 1. 輔助函式：取得倍率對應的顏色 (與生成邏輯一致)
    getSpringColor(mul) {
        if(mul >= 10000) return '#00ffff';
        if(mul >= 1000) return '#ffffff';
        if(mul >= 500) return '#2563eb';
        if(mul >= 100) return '#9333ea';
        if(mul >= 50) return '#db2777';
        if(mul >= 25) return '#ef4444';
        if(mul >= 10) return '#f97316';
        if(mul >= 5) return '#fbbf24';
        return '#22c55e'; // x2 default
    }

    // 新增：取得畫面最左側的有效彈簧 (作為 Target)
    getTargetSpring() {
        // 忽略已經跑過頭的彈簧 (馬在 0.3*900 = 270)
        // 設定一個閾值，例如 180，小於此值的彈簧視為已錯過
        // 這樣 UI 會在彈簧經過馬屁股後立刻切換到下一個
        const threshold = 180;
        return this.springs.find(s => s.x > threshold);
    }

    updateRoadmapUI() {
        const pastContainer = document.getElementById('roadmapPast');
        const futureContainer = document.getElementById('roadmapFuture');
        
        const showPast = this.roadmapPast.slice(-5);
        let pastHTML = '';
        showPast.forEach(item => {
            pastHTML += `
                <div class="roadmap-item w-9 h-9 rounded flex items-center justify-center text-xs font-bold border border-white/20" style="background-color: ${item.color}; color: ${item.textColor}">
                    ${item.mul >= 1000 ? 'K' : item.mul}
                </div>
            `;
        });
        pastContainer.innerHTML = pastHTML;

        const showFuture = this.roadmapFuture.slice(0, 10);
        let futureHTML = '';
        showFuture.forEach((item, index) => {
            const sizeClass = index === 0 ? 'w-12 h-12 text-xl border-2 border-white animate-pulse' : 'w-9 h-9 text-xs opacity-80';
            const label = item.mul >= 1000 ? (item.mul===10000 ? 'MAX' : '1K') : item.mul;
            
            futureHTML += `
                <div class="roadmap-item rounded-lg flex items-center justify-center font-black shadow-md ${sizeClass}" style="background-color: ${item.color}; color: ${item.textColor}">
                    ${label}
                </div>
            `;
        });
        futureContainer.innerHTML = futureHTML;
    }

    resize() {
        const winW = window.innerWidth;
        const winH = window.innerHeight;
        const isMobile = winH > winW;
        
        this.width = 900; 

        if (isMobile) {
            const scale = winW / this.width;
            this.height = Math.ceil(winH / scale);
            this.wrapper.style.width = `${this.width}px`;
            this.wrapper.style.height = `${this.height}px`;
            this.wrapper.style.transformOrigin = '0 0';
            this.wrapper.style.transform = `scale(${scale})`;
            this.wrapper.style.left = '0px';
            this.wrapper.style.top = '0px';
            this.wrapper.style.borderRadius = '0px';
        } else {
            this.height = 1600;
            const scale = Math.min(winW / this.width, winH / this.height);
            this.wrapper.style.width = `${this.width}px`;
            this.wrapper.style.height = `${this.height}px`;
            this.wrapper.style.transformOrigin = 'center center';
            this.wrapper.style.transform = `translate(-50%, -50%) scale(${scale})`;
            this.wrapper.style.left = '50%';
            this.wrapper.style.top = '50%';
            this.wrapper.style.borderRadius = '20px';
        }

        this.canvas.width = this.width;
        this.canvas.height = this.height;

        this.groundLevel = this.height - 680; 
        this.horseBaseY = this.groundLevel - 70;
        
        if (this.state === 'GROUND') {
            this.horse.y = this.horseBaseY;
            this.horse.x = this.width * 0.3;
        }
    }

    setBet(amount) {
        if (this.hitCooldown > 0 || this.isFiring) return; 
        this.betAmount = amount;
        const display = document.getElementById('currentBetDisplay');
        display.classList.remove('shake');
        void display.offsetWidth;
        display.classList.add('shake');
        this.updateUI();
    }

    updateUI() {
        document.getElementById('balanceDisplay').innerText = this.formatCurrency(this.balance);
        
        // 需求1: 右上角 Bonus 顯示邏輯 (修正)
        let displayMul = this.currentMultiplier;
        let displayColor = '#60a5fa'; // 預設藍
        let labelText = "ACTIVE";

        if (this.state === 'GROUND') {
            labelText = "TARGET";
            // 優先抓取場景上「即將遭遇」的彈簧
            const target = this.getTargetSpring();
            if (target) {
                displayMul = target.mul;
                displayColor = target.color;
            } else if (this.roadmapFuture.length > 0) {
                // 如果場景空了，顯示未來第一個
                displayMul = this.roadmapFuture[0].mul;
                displayColor = this.roadmapFuture[0].color;
            }
        } else {
            // SKY 模式：顯示當前作用中的倍率
            displayColor = this.getSpringColor(this.currentMultiplier);
        }

        const mulDisplay = document.getElementById('multiplierDisplay');
        mulDisplay.innerText = 'x' + displayMul;
        mulDisplay.style.color = displayColor;
        
        document.getElementById('bonusLabel').innerText = labelText;
        
        document.getElementById('currentBetDisplay').innerText = this.formatCurrency(this.betAmount);

        const skyHUD = document.getElementById('skyHUD');
        const groundControls = document.getElementById('groundControls');
        const hitUI = document.getElementById('hitCooldownUI');
        const betPanel = document.getElementById('betPanel');
        
        const centerHUD = document.getElementById('centerHUD');
        const centerAlertBg = document.getElementById('centerAlertBg');
        const centerAlertText = document.getElementById('centerAlertText');
        const centerAlertIcon = document.getElementById('centerAlertIcon');
        
        // 修正：移除地面狀態下的中央閃爍提示
        if (this.state === 'GROUND') {
            centerHUD.style.opacity = 0;
        }

        if (this.state === 'SKY' || this.state === 'LAUNCHING') {
            skyHUD.style.opacity = 1;
            groundControls.style.opacity = 0;
            hitUI.style.opacity = 1;
            const pct = (this.skyTimer / this.skyDurationMax) * 100;
            document.getElementById('skyTimerBar').style.width = Math.max(0, Math.min(100, pct)) + '%';
            
            const revolverContainer = document.getElementById('revolverContainer');
            const ammoText = document.getElementById('ammoText');
            
            let bulletsLoaded = 6;
            let rotation = 0;

            if (this.hitCooldown > 0) {
                // 冷卻中
                const progress = 1 - (this.hitCooldown / this.hitCooldownMax);
                bulletsLoaded = Math.floor(progress * 6); 
                rotation = bulletsLoaded * 60;
                
                ammoText.innerText = "LOAD";
                ammoText.className = "text-xl font-black text-yellow-400 ui-font animate-pulse";
                betPanel.classList.add('processing');

                centerHUD.style.opacity = 1;
                centerAlertBg.className = "absolute inset-0 rounded-xl transform -skew-x-12 shadow-[0_0_30px_rgba(250,204,21,0.6)] bg-yellow-600/80 border-4 border-yellow-400 animate-flash";
                centerAlertText.innerText = "RELOADING...";
                centerAlertText.className = "text-5xl font-black ui-font text-yellow-100 drop-shadow-[0_4px_0_#000] tracking-widest italic whitespace-nowrap";
                centerAlertIcon.innerText = "⚠️";

            } else if (this.isFiring) {
                // 射擊中
                bulletsLoaded = 0;
                rotation = this.gameTick * 30; 
                
                ammoText.innerText = "FIRE";
                ammoText.className = "text-xl font-black text-red-500 ui-font";
                betPanel.classList.add('processing');
                centerHUD.style.opacity = 0; 
            } else {
                // 就緒
                bulletsLoaded = 6;
                rotation = 0;
                
                ammoText.innerText = "RDY";
                ammoText.className = "text-xl font-black text-green-400 ui-font";
                betPanel.classList.remove('processing');

                centerHUD.style.opacity = 0;
            }

            revolverContainer.style.transform = `rotate(${rotation}deg)`;

            for (let i = 0; i < 6; i++) {
                const bullet = document.getElementById(`bullet-slot-${i}`);
                if (bullet) {
                    if (i < bulletsLoaded) {
                        bullet.classList.remove('scale-0');
                        bullet.classList.add('scale-100');
                    } else {
                        bullet.classList.remove('scale-100');
                        bullet.classList.add('scale-0');
                    }
                }
            }

        } else {
            skyHUD.style.opacity = 0;
            groundControls.style.opacity = 1;
            hitUI.style.opacity = 0;
            betPanel.classList.remove('processing');
            // Ground check moved to top of function
        }
    }

    handleInput(e) {
        e.preventDefault();
        this.audio.init();

        const rect = this.canvas.getBoundingClientRect();
        const scaleX = this.width / rect.width;
        const scaleY = this.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;

        if (x < 0 || x > this.width || y < 0 || y > this.height) return;

        if (this.state === 'GROUND') {
            // 需求4: 點擊任意處起飛，鎖定「當前顯示」的彈簧
            const target = this.getTargetSpring();
            if (target) {
                this.attemptLaunch(target);
            }
        } 
        else if (this.state === 'SKY') {
            if (this.hitCooldown > 0 || this.isFiring) return; 

            if (this.balance >= this.betAmount) {
                this.startShootingRound(x, y);
            } else {
                this.spawnText("NO MONEY!", this.horse.x, this.horse.y, '#ef4444', 50);
            }
        }
    }

    spawnSpring() {
        const selected = this.roadmapFuture.shift();
        
        this.springs.push({
            x: this.width + 150, 
            y: this.groundLevel + 20, 
            w: 120,
            h: 70,
            mul: selected.mul,
            color: selected.color,
            textColor: selected.textColor,
            label: selected.label,
            glow: selected.glow || false,
            active: true,
            pulse: 0,
            compress: 0 
        });

        this.roadmapPast.push(selected); 
        this.roadmapFuture.push(this.generateWeightedMultiplier()); 
        this.updateRoadmapUI(); 
    }

    attemptLaunch(spring) {
        this.updateUI();
        this.audio.playJump();

        this.createParticles(spring.x, spring.y + 10, 1, 'rgba(255,255,255,0.8)', 'shockwave');
        this.createParticles(spring.x, spring.y, 20, spring.color, 'spark');
        spring.compress = 20;
        spring.active = false; 

        setTimeout(() => {
            this.state = 'LAUNCHING';
            this.currentMultiplier = spring.mul;
            this.horse.vy = -22; 
            this.horse.state = 'FLY';
            this.skyTimer = this.skyDurationMax; 
            
            this.horse.targetX = this.width * 0.3;
            this.horse.moveTimer = 0;
            this.horse.pinataHits = 0; 
            this.horse.animScaleX = 1;
            this.horse.animScaleY = 1;
            this.horse.scaleVx = 0;
            this.horse.scaleVy = 0;

            this.shakeScreen(20);
            
            let label = spring.mul >= 1000 ? 'JACKPOT!' : `x${spring.mul} BOOST!`;
            this.spawnText(label, this.width/2, this.height/2, spring.color, 100);
            
            for(let i=0; i<30; i++) {
                this.particles.push({
                    type: 'line',
                    x: this.width + Math.random()*200,
                    y: this.horse.y + (Math.random()-0.5)*300,
                    vx: -30 - Math.random()*30,
                    vy: 0,
                    life: 45,
                    color: 'white',
                    w: 100, h: 4
                });
            }

        }, 50);
    }

    startShootingRound(inputX, inputY) {
        this.balance -= this.betAmount;
        this.saveBalance();
        this.updateUI();

        let winChance = 0.96 / this.currentMultiplier;
        let roll = Math.random();
        
        let result = 'MISS';
        if (roll < winChance) {
            result = 'WIN';
        } else {
            let explodeRisk = 0.0 + (this.horse.pinataHits * 0.015);
            if (this.currentMultiplier >= 100) explodeRisk += 0.01;
            if (Math.random() < explodeRisk) result = 'EXPLODE';
        }
        
        this.pendingResult = result;
        this.isFiring = true;
        this.fireQueue = 6; 
        this.fireTimer = 0; 
    }

    spawnBullet() {
        this.audio.playShoot();
        this.bullets.push({
            x: this.width / 2 + (Math.random() - 0.5) * 100,
            y: this.height + 20,
            targetX: this.horse.x, 
            targetY: this.horse.y,
            speed: 45, 
            isLast: this.fireQueue === 1,
            betAmount: this.betAmount 
        });
        this.fireQueue--;
    }

    bulletHit(b) {
        this.horse.pinataHits++;
        
        this.horse.animScaleX = 1.3; 
        this.horse.animScaleY = 0.7; 
        this.horse.scaleVx = (Math.random() - 0.5) * 0.3;
        this.horse.scaleVy = 0.2; 
        this.horse.faceTimer = 20; 
        this.shakeScreen(15);
        this.audio.playHit();
        
        this.createParticles(this.horse.x, this.horse.y, 20, '#fff', 'spark');

        if (b.isLast) {
            this.isFiring = false;
            this.hitCooldown = this.hitCooldownMax;
            this.audio.playReload();

            this.skyTimer = this.skyDurationMax; 

            if (this.pendingResult === 'WIN') {
                this.triggerWin();
            } else {
                // 斷連勝邏輯
                if (this.pendingResult === 'EXPLODE') {
                    setTimeout(() => { this.explodePinata(); }, 200);
                } else {
                    this.spawnText("MISS!", this.horse.x, this.horse.y - 80, '#9ca3af', 40);
                }
                
                // 如果之前有連勝，顯示連勝中斷
                if (this.winStreak >= 3) {
                     this.spawnText("STREAK LOST", this.horse.x, this.horse.y + 50, '#ef4444', 40);
                }
                this.winStreak = 0;
            }
            this.updateUI();
        }
    }

    explodePinata() {
        this.shakeScreen(60); 
        this.flashAlpha = 1.0; 
        this.audio.playExplode(); 
        
        this.createParticles(this.horse.x, this.horse.y, 100, '#ec4899', 'confetti');
        this.createParticles(this.horse.x, this.horse.y, 50, '#fff', 'spark');
        this.createParticles(this.horse.x, this.horse.y, 5, '#fff', 'shockwave');
        this.createParticles(this.horse.x, this.horse.y, 20, '#ffff00', 'line');
        
        this.spawnText("BROKEN!", this.horse.x, this.horse.y - 50, '#ef4444', 90);
        
        this.state = 'FALLING';
        this.horse.vy = 0;
        this.winStreak = 0; // 爆炸也會重置連勝
        this.updateUI();
    }

    triggerWin() {
        const win = this.betAmount * this.currentMultiplier;
        this.balance += win;
        this.saveBalance(); 
        this.audio.playWin(); 
        
        this.winStreak++; // 增加連勝
        
        this.spawnText(`+${this.formatCurrency(win)}`, this.horse.x, this.horse.y - 100, '#FACC15', 60);
        
        if (this.winStreak >= 2) {
             let streakColor = this.winStreak >= 3 ? '#ef4444' : '#fbbf24';
             this.spawnText(`STREAK x${this.winStreak}`, this.horse.x, this.horse.y - 160, streakColor, 40, 'comic');
        }

        this.createParticles(this.horse.x, this.horse.y, 40, '#FACC15', 'coin');
        this.createParticles(this.horse.x, this.horse.y, 20, '#ffff00', 'line'); 
    }

    shakeScreen(intensity) {
        this.camera.shake = Math.max(this.camera.shake, intensity);
    }

    spawnText(str, x, y, color, size=32, type='normal') {
        this.texts.push({
            str, x, y, color, size, type,
            vy: -4, life: 60, maxLife: 60,
            rotation: type === 'comic' ? (Math.random() - 0.5) * 0.5 : 0 
        });
    }

    createParticles(x, y, count, color, type='spark') {
        for(let i=0; i<count; i++) {
            let p = {
                x, y,
                vx: (Math.random() - 0.5) * 20,
                vy: (Math.random() - 0.5) * 20,
                life: 30 + Math.random() * 20,
                maxLife: 30 + Math.random() * 20,
                color,
                type,
                size: Math.random() * 8 + 4,
                gravity: 0.6,
                rotation: Math.random() * 360,
                rotSpeed: (Math.random() - 0.5) * 10
            };
            
            if (type === 'coin') {
                p.vx = (Math.random() - 0.5) * 25;
                p.vy = -25 - Math.random() * 20;
                p.gravity = 1.2;
                p.life = 70;
                p.size = 14;
            } else if (type === 'shockwave') {
                p.vx = 0; p.vy = 0; p.gravity = 0;
                p.life = 20; p.maxLife = 20;
                p.size = 10;
                p.growth = 20; 
            } else if (type === 'confetti') {
                p.gravity = 0.2;
                p.vx *= 1.5;
                p.vy *= 1.5;
                p.life = 60;
                const colors = ['#ec4899', '#3b82f6', '#eab308', '#22c55e', '#a855f7'];
                p.color = colors[Math.floor(Math.random() * colors.length)];
                p.w = 12; p.h = 6;
            } else if (type === 'line') {
                p.vx = (Math.random() - 0.5) * 40;
                p.vy = (Math.random() - 0.5) * 40;
                p.life = 15;
                p.w = 30; p.h = 4;
            }
            this.particles.push(p);
        }
    }

    update() {
        this.gameTick++;
        
        if (this.camera.shake > 0) {
            this.camera.shake *= 0.9;
            if (this.camera.shake < 0.5) this.camera.shake = 0;
        }

        if (this.state !== 'LAUNCHING') {
            this.bgScroll += this.groundSpeed;
        }

        if (this.hitCooldown > 0) {
            this.hitCooldown--;
            if (this.hitCooldown % 2 === 0) this.updateUI(); 
        }

        // Q彈物理
        const targetScale = 1.0;
        const stiffness = 0.2; 
        const damping = 0.8;    

        const forceX = (targetScale - this.horse.animScaleX) * stiffness;
        this.horse.scaleVx += forceX;
        this.horse.scaleVx *= damping;
        this.horse.animScaleX += this.horse.scaleVx;

        const forceY = (targetScale - this.horse.animScaleY) * stiffness;
        this.horse.scaleVy += forceY;
        this.horse.scaleVy *= damping;
        this.horse.animScaleY += this.horse.scaleVy;

        if (this.horse.faceTimer > 0) this.horse.faceTimer--;

        if (this.state === 'SKY' && this.horse.faceTimer <= 0) {
            const breath = Math.sin(this.gameTick * 0.15); 
            this.horse.animScaleX = 1.0 + breath * 0.1; 
            this.horse.animScaleY = 1.0 - breath * 0.1;
            
            this.horse.y += Math.sin(this.gameTick * 0.1) * 2;

            if (Math.random() < 0.03) {
                this.horse.tongueOut = 1.0; 
                setTimeout(() => { this.horse.tongueOut = 0; }, 1200);
            }
            if (Math.random() < 0.03) {
                this.horse.buttWiggle = 1.0;
                setTimeout(() => { this.horse.buttWiggle = 0; }, 1000);
            }
            
            if (this.horse.buttWiggle > 0 || this.horse.tongueOut > 0) {
                 this.horse.angle = Math.sin(this.gameTick * 0.3) * 0.3; 
            }
        } else {
            this.horse.tongueOut = 0;
            this.horse.buttWiggle = 0;
        }

        this.audio.setSkyMode(this.state === 'SKY' || this.state === 'LAUNCHING');

        this.clouds.forEach(c => {
            c.x -= c.speed;
            if (c.x < -200) {
                c.x = this.width + 200;
                if (this.state === 'SKY') {
                        c.y = Math.random() * this.height; 
                } else {
                        c.y = Math.random() * (this.height * 0.4); 
                }
            }
        });

        // 射擊循環
        if (this.isFiring && this.fireQueue > 0) {
            this.fireTimer++;
            if (this.fireTimer >= 3) { // 每 3 幀發射一發 (高速)
                this.spawnBullet();
                this.fireTimer = 0;
            }
        }

        // 子彈更新
        for (let i = this.bullets.length - 1; i >= 0; i--) {
            let b = this.bullets[i];
            let dx = this.horse.x - b.x;
            let dy = this.horse.y - b.y;
            let angle = Math.atan2(dy, dx);
            b.x += Math.cos(angle) * b.speed;
            b.y += Math.sin(angle) * b.speed;
            
            let dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 60) {
                this.bulletHit(b);
                this.bullets.splice(i, 1);
            } else if (b.y < -100 || b.x < -100 || b.x > this.width + 100) {
                this.bullets.splice(i, 1);
            }
        }

        if (this.state === 'GROUND') {
            this.horse.y = this.horseBaseY + Math.sin(this.gameTick * 0.2) * 6;
            this.horse.x = this.width * 0.3; 
            
            this.springSpawnTimer++;
            if (this.springSpawnTimer > 22) { 
                this.spawnSpring();
                this.springSpawnTimer = 0;
                this.springSpawnTimer -= Math.random() * 10; 
            }

            for (let i = this.springs.length - 1; i >= 0; i--) {
                let s = this.springs[i];
                s.x -= this.groundSpeed;
                
                if (s.compress > 0) s.compress *= 0.8;
                s.pulse = Math.sin(this.gameTick * 0.2) * 0.1 + 1; 

                if (s.x < -200) {
                    this.springs.splice(i, 1);
                }
            }
            
            // 加入動態更新 UI，確保 TARGET 倍數即時同步
            this.updateUI();
        }
        else if (this.state === 'LAUNCHING') {
            let targetY = this.height * 0.3;
            this.horse.y += (targetY - this.horse.y) * 0.08;
            this.horse.x = this.width * 0.3; 
            
            this.springs.forEach(s => s.x -= this.groundSpeed * 3);
            
            if (Math.abs(this.horse.y - targetY) < 20) {
                this.state = 'SKY';
            }
        }
        else if (this.state === 'SKY') {
            this.horse.moveTimer--;
            if (this.horse.moveTimer <= 0) {
                this.horse.targetX = this.width * 0.2 + Math.random() * (this.width * 0.6);
                this.horse.targetY = this.height * 0.15 + Math.random() * (this.height * 0.4);
                this.horse.moveTimer = 40 + Math.random() * 40; 
            }
            
            let dx = this.horse.targetX - this.horse.x;
            let dy = this.horse.targetY - this.horse.y;
            
            this.horse.x += dx * 0.05;
            this.horse.y += dy * 0.05;

            if (this.horse.state === 'SPIN') {
                this.horse.angle += 0.4; 
                this.horse.spinTimer--;
                if (this.horse.spinTimer <= 0) {
                    this.horse.state = 'FLY';
                    this.horse.angle = 0;
                }
            } else {
                this.horse.wobble += 0.05;
                this.horse.angle = Math.sin(this.horse.wobble) * 0.1;
            }

            if (!this.isFiring && this.hitCooldown === 0) {
                this.skyTimer--;
            }
            this.updateUI();

            if (this.skyTimer <= 0) {
                this.explodePinata();
            }
        }
        else if (this.state === 'FALLING') {
            let targetY = this.horseBaseY;
            this.horse.y += (targetY - this.horse.y) * 0.06;
            
            let targetX = this.width * 0.3;
            this.horse.x += (targetX - this.horse.x) * 0.06;
            
            this.horse.angle += 0.2; 
            
            if (Math.abs(this.horse.y - targetY) < 20) {
                this.state = 'GROUND';
                this.currentMultiplier = 1; 
                this.horse.y = this.horseBaseY;
                this.horse.state = 'RUN';
                this.horse.angle = 0;
                this.horse.x = this.width * 0.3;
                this.shakeScreen(15);
                this.createParticles(this.horse.x, this.horse.y+80, 50, '#5c4033', 'spark');
                
                this.springs = [];
                this.springSpawnTimer = 40;
                this.updateUI();
            }
        }

        this.updateParticles();
        this.updateTexts();
    }

    updateParticles() {
        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            p.life--;
            
            if (p.type === 'coin') {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity;
            } else if (p.type === 'shockwave') {
                p.size += p.growth; 
                p.growth *= 0.9;
            } else if (p.type === 'line') {
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.9; p.vy *= 0.9;
            } else if (p.type === 'confetti') {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity;
                p.rotation += p.rotSpeed;
                p.vx *= 0.95; 
            } else {
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.9;
                if (this.state === 'GROUND') p.x -= this.groundSpeed;
            }
            if (p.life <= 0) this.particles.splice(i, 1);
        }
    }

    updateTexts() {
        for (let i = this.texts.length - 1; i >= 0; i--) {
            let t = this.texts[i];
            t.y += t.vy;
            t.life--;
            t.vy *= 0.92;
            if (t.type === 'comic') {
                if (t.life > 50) t.size += 2; 
                else if (t.life < 10) t.size *= 0.8; 
            } else {
                if (this.state === 'GROUND') t.x -= 4; 
            }
            if (t.life <= 0) this.texts.splice(i, 1);
        }
    }

    draw() {
        let shakeX = (Math.random() - 0.5) * this.camera.shake;
        let shakeY = (Math.random() - 0.5) * this.camera.shake;

        this.ctx.save();
        this.ctx.translate(shakeX, shakeY);

        this.drawBackground();
        
        if (this.state === 'GROUND') this.drawGroundElements();
        
        if (this.state === 'SKY') {
            this.drawPinata();
        } else {
            this.drawHorse();
        }
        
        // 繪製 KUSO 子彈
        this.bullets.forEach(b => {
            this.ctx.save();
            this.ctx.translate(b.x, b.y);
            
            // 計算朝向角度
            const dx = this.horse.x - b.x;
            const dy = this.horse.y - b.y;
            const angle = Math.atan2(dy, dx);
            this.ctx.rotate(angle);

            if (b.betAmount === 1) {
                // $1: 豌豆 (Green Pea)
                this.ctx.fillStyle = '#4ade80';
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 8, 0, Math.PI*2);
                this.ctx.fill();
                this.ctx.fillStyle = '#bbf7d0';
                this.ctx.beginPath();
                this.ctx.arc(-3, -3, 3, 0, Math.PI*2);
                this.ctx.fill();

            } else if (b.betAmount === 10) {
                // $10: 藍白拖 (Blue Slipper)
                this.ctx.rotate(Math.PI/2); // 橫向飛
                this.ctx.fillStyle = '#3b82f6';
                this.ctx.beginPath();
                this.ctx.roundRect(-15, -25, 30, 50, 10);
                this.ctx.fill();
                this.ctx.strokeStyle = 'white';
                this.ctx.lineWidth = 5;
                this.ctx.beginPath();
                this.ctx.moveTo(-15, -10);
                this.ctx.lineTo(0, -25);
                this.ctx.lineTo(15, -10);
                this.ctx.stroke();

            } else if (b.betAmount === 50) {
                // $50: 紅磚頭 (Red Brick)
                this.ctx.fillStyle = '#b91c1c';
                this.ctx.fillRect(-20, -12, 40, 24);
                // 磚孔
                this.ctx.fillStyle = '#7f1d1d';
                this.ctx.beginPath();
                this.ctx.arc(-10, 0, 4, 0, Math.PI*2);
                this.ctx.arc(10, 0, 4, 0, Math.PI*2);
                this.ctx.fill();

            } else if (b.betAmount === 100) {
                // $100: 鈔票磚 (Money)
                this.ctx.fillStyle = '#22c55e';
                this.ctx.fillRect(-20, -12, 40, 24);
                this.ctx.strokeStyle = '#dcfce7';
                this.ctx.lineWidth = 3;
                this.ctx.strokeRect(-20, -12, 40, 24);
                this.ctx.fillStyle = '#dcfce7';
                this.ctx.font = 'bold 16px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText('$', 0, 2);

            } else { // $1000 & Default
                // $1000: 飛彈 (Missile)
                this.ctx.fillStyle = '#e5e7eb'; // 銀身
                this.ctx.beginPath();
                this.ctx.ellipse(0, 0, 25, 10, 0, 0, Math.PI*2);
                this.ctx.fill();
                this.ctx.fillStyle = '#ef4444'; // 紅頭
                this.ctx.beginPath();
                this.ctx.moveTo(15, -7);
                this.ctx.lineTo(30, 0);
                this.ctx.lineTo(15, 7);
                this.ctx.fill();
                this.ctx.fillStyle = '#374151'; // 尾翼
                this.ctx.beginPath();
                this.ctx.moveTo(-15, -8); this.ctx.lineTo(-25, -15); this.ctx.lineTo(-20, -2);
                this.ctx.fill();
                this.ctx.beginPath();
                this.ctx.moveTo(-15, 8); this.ctx.lineTo(-25, 15); this.ctx.lineTo(-20, 2);
                this.ctx.fill();
                // 尾焰
                this.ctx.strokeStyle = '#f59e0b';
                this.ctx.lineWidth = 4;
                this.ctx.beginPath();
                this.ctx.moveTo(-25, 0);
                this.ctx.lineTo(-40 - Math.random()*10, 0);
                this.ctx.stroke();
            }

            this.ctx.restore();
        });

        this.drawEffects();

        if (this.flashAlpha > 0) {
            this.ctx.fillStyle = `rgba(255, 255, 255, ${this.flashAlpha})`;
            this.ctx.fillRect(0, 0, this.width, this.height);
            this.flashAlpha *= 0.85; 
            if (this.flashAlpha < 0.01) this.flashAlpha = 0;
        }
        
        // 繪製 Streak UI
        if (this.state === 'SKY' && this.winStreak >= 2) {
             this.ctx.save();
             this.ctx.textAlign = 'center';
             this.ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
             this.ctx.font = '900 120px "Black Ops One"';
             this.ctx.translate(this.width/2, this.height/2 + 200);
             this.ctx.rotate(-0.1);
             this.ctx.fillText(`${this.winStreak}`, 0, 0);
             this.ctx.font = '900 40px "Black Ops One"';
             this.ctx.fillText("STREAK", 0, 50);
             this.ctx.restore();
        }

        this.ctx.restore();
    }

    drawBackground() {
        let grd = this.ctx.createLinearGradient(0, 0, 0, this.height);
        
        if (this.state === 'GROUND') {
            grd.addColorStop(0, "#1e40af");
            grd.addColorStop(1, "#60a5fa");
        } else if (this.state === 'SKY' || this.state === 'LAUNCHING') {
            if (this.horse.faceTimer > 0) {
                const hue = (this.gameTick * 20) % 360;
                grd = this.ctx.createLinearGradient(0, 0, 0, this.height);
                grd.addColorStop(0, `hsl(${hue}, 70%, 20%)`);
                grd.addColorStop(1, `hsl(${hue + 60}, 70%, 40%)`);
            } else {
                // 3. 尊爵不凡背景：根據倍率改變背景色調
                if (this.currentMultiplier >= 1000) {
                    grd.addColorStop(0, "#000000");
                    grd.addColorStop(1, "#2e1065"); // 深紫宇宙
                } else if (this.currentMultiplier >= 50) {
                    grd.addColorStop(0, "#451a03"); // 金色氛圍
                    grd.addColorStop(1, "#b45309");
                } else {
                    grd.addColorStop(0, "#4a044e");
                    grd.addColorStop(1, "#c026d3");
                }
                
                // 狂暴模式：背景脈衝
                if (this.winStreak >= 3) {
                     let pulse = Math.sin(this.gameTick * 0.2) * 0.2;
                     // 疊加紅色濾鏡
                     this.ctx.save();
                     this.ctx.globalCompositeOperation = 'overlay';
                }
            }
        } else {
            grd.addColorStop(0, "#1d4ed8");
            grd.addColorStop(1, "#93c5fd");
        }
        this.ctx.fillStyle = grd;
        this.ctx.fillRect(0, 0, this.width, this.height);
        
        // 狂暴模式的紅色濾鏡
        if (this.state === 'SKY' && this.winStreak >= 3) {
             this.ctx.fillStyle = `rgba(255, 0, 0, ${0.1 + Math.sin(this.gameTick*0.2)*0.05})`;
             this.ctx.fillRect(0, 0, this.width, this.height);
        }

        if (this.state === 'SKY' || this.state === 'LAUNCHING') {
             this.ctx.fillStyle = 'white';
             for(let i=0; i<30; i++) {
                 let sx = (this.gameTick * 2 + i * 137) % this.width;
                 let sy = (i * 93) % this.height;
                 this.ctx.globalAlpha = 0.5 + Math.sin(this.gameTick * 0.1 + i) * 0.5;
                 this.ctx.fillRect(sx, sy, 3, 3);
             }
             this.ctx.globalAlpha = 1.0;
        }

        this.clouds.forEach(c => {
            this.ctx.fillStyle = `rgba(255, 255, 255, ${c.alpha})`;
            this.ctx.beginPath();
            this.ctx.arc(c.x, c.y, c.size, 0, Math.PI*2);
            this.ctx.arc(c.x + c.size*0.7, c.y + c.size*0.2, c.size*0.6, 0, Math.PI*2);
            this.ctx.arc(c.x - c.size*0.7, c.y + c.size*0.2, c.size*0.6, 0, Math.PI*2);
            this.ctx.fill();
        });

        if (this.state === 'LAUNCHING') {
            this.ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            this.ctx.lineWidth = 4;
            this.ctx.beginPath();
            for(let i=0; i<this.height; i+=150) {
                let xOffset = (this.gameTick * 40 + i) % this.width;
                this.ctx.moveTo(xOffset, i);
                this.ctx.lineTo(xOffset + 200, i);
            }
            this.ctx.stroke();
        }
    }

    drawGroundElements() {
        this.ctx.fillStyle = '#166534';
        this.ctx.fillRect(0, this.groundLevel, this.width, this.height - this.groundLevel);
        
        this.ctx.fillStyle = '#14532d';
        let stripeWidth = 80;
        let offset = -(this.bgScroll % stripeWidth);
        for (let x = offset; x < this.width; x += stripeWidth) {
             this.ctx.beginPath();
             this.ctx.moveTo(x, this.height);
             this.ctx.lineTo(x + 50, this.groundLevel);
             this.ctx.lineTo(x + 20, this.groundLevel);
             this.ctx.lineTo(x - 30, this.height);
             this.ctx.fill();
        }

        this.ctx.fillStyle = '#facc15';
        let dashWidth = 100;
        let dashGap = 100;
        let dashOffset = -(this.bgScroll % (dashWidth + dashGap));
        for (let x = dashOffset; x < this.width; x += (dashWidth + dashGap)) {
            this.ctx.fillRect(x, this.groundLevel + 20, dashWidth, 15);
        }

        this.springs.forEach(s => {
            if (!s.active) this.ctx.globalAlpha = 0.5; 

            this.ctx.fillStyle = '#1f2937';
            this.ctx.beginPath();
            this.ctx.roundRect(s.x - s.w/2, s.y, s.w, 20, 5);
            this.ctx.fill();

            this.ctx.strokeStyle = '#9ca3af';
            this.ctx.lineWidth = 12;
            this.ctx.lineCap = 'round';
            this.ctx.beginPath();
            let y = s.y;
            let h = s.h;
            let ph = h * s.pulse - s.compress; 
            ph = Math.max(10, ph);

            this.ctx.moveTo(s.x - 40, y);
            this.ctx.lineTo(s.x + 40, y - ph*0.3);
            this.ctx.lineTo(s.x - 40, y - ph*0.6);
            this.ctx.lineTo(s.x + 40, y - ph);
            this.ctx.moveTo(s.x, y - ph);
            this.ctx.stroke();

            let boxY = s.y - ph - 25;
            let boxW = 110;
            let boxH = 70;
            
            this.ctx.save();
            this.ctx.translate(s.x, boxY);
            let scaleY = 1 - (s.compress / 60);
            this.ctx.scale(s.pulse, s.pulse * scaleY);
            
            this.ctx.shadowBlur = s.glow ? 50 : 30;
            this.ctx.shadowColor = s.color;
            
            this.ctx.fillStyle = s.color;
            this.ctx.beginPath();
            this.ctx.roundRect(-boxW/2, -boxH/2, boxW, boxH, 15);
            this.ctx.fill();
            
            this.ctx.strokeStyle = 'white';
            this.ctx.lineWidth = 4;
            this.ctx.stroke();
            
            this.ctx.shadowBlur = 0;

            this.ctx.fillStyle = s.textColor;
            let fontSize = 48;
            if (s.label.length >= 4) fontSize = 36;
            this.ctx.font = `900 ${fontSize}px "Black Ops One"`; 
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.fillText(s.label, 0, 4); 

            this.ctx.restore();
            this.ctx.globalAlpha = 1.0;
        });
    }

    drawPinata() {
        this.ctx.save();
        this.ctx.translate(this.horse.x, this.horse.y);
        
        let scaleX = this.horse.scale * 1.8 * this.horse.animScaleX;
        let scaleY = this.horse.scale * 1.8 * this.horse.animScaleY;
        this.ctx.scale(scaleX, scaleY); 
        this.ctx.rotate(this.horse.angle);

        // 狂暴光環
        if (this.winStreak >= 3) {
             this.ctx.shadowBlur = 20 + Math.sin(this.gameTick*0.5)*10;
             this.ctx.shadowColor = '#ef4444';
        }

        this.ctx.strokeStyle = '#fff';
        this.ctx.lineWidth = 2;
        this.ctx.beginPath();
        this.ctx.moveTo(0, -60);
        this.ctx.lineTo(0, -1000); 
        this.ctx.stroke();

        // 3. 尊爵不凡 PINATA 外觀切換
        let colors = ['#ec4899', '#a855f7', '#3b82f6', '#22c55e', '#eab308']; // 預設 x2
        let isMetal = false;
        let isGold = false;
        let isCosmic = false;

        if (this.currentMultiplier >= 1000) {
            isCosmic = true;
            colors = ['#000', '#1e1b4b', '#312e81', '#4338ca', '#000']; 
        } else if (this.currentMultiplier >= 50) {
            isGold = true;
            colors = ['#f59e0b', '#fbbf24', '#fcd34d', '#b45309', '#78350f']; 
        } else if (this.currentMultiplier >= 10) {
            isMetal = true;
            // 3. 視覺調整：機械版改為 Cyberpunk 風格
            colors = ['#1e293b', '#334155', '#475569', '#06b6d4', '#0891b2'];
        }
        
        // 狂暴模式下身體顏色變化
        if (this.winStreak >= 3) {
             colors[0] = '#ef4444'; // 頭部變紅
             colors[1] = '#b91c1c'; // 耳朵變深紅
        }
        
        // 繪製身體
        for(let i=0; i<5; i++) {
            this.ctx.fillStyle = colors[i % colors.length];
            let offset = Math.sin(this.gameTick * 0.2 + i) * 2;
            this.ctx.beginPath();
            this.ctx.roundRect(-35 + offset, -30 + i*12, 70, 15, 2);
            this.ctx.fill();
            
            if (isGold) { // 黃金光澤
                this.ctx.strokeStyle = '#fef08a';
                this.ctx.lineWidth = 1;
                this.ctx.stroke();
            }
            if (isMetal) { // 3. 機械版：增加能量線條
                this.ctx.strokeStyle = '#06b6d4';
                this.ctx.lineWidth = 2;
                this.ctx.shadowBlur = 5;
                this.ctx.shadowColor = '#06b6d4';
                this.ctx.beginPath();
                this.ctx.moveTo(-35 + offset + 10, -30 + i*12 + 7);
                this.ctx.lineTo(-35 + offset + 60, -30 + i*12 + 7);
                this.ctx.stroke();
                this.ctx.shadowBlur = 0;
            }
        }

        // 神聖光環 (宇宙版)
        if (isCosmic) {
            this.ctx.shadowBlur = 30;
            this.ctx.shadowColor = '#8b5cf6';
            this.ctx.strokeStyle = 'white';
            this.ctx.lineWidth = 3;
            this.ctx.beginPath();
            this.ctx.arc(0, 0, 80, 0, Math.PI*2);
            this.ctx.stroke();
            this.ctx.shadowBlur = 0;
        }

        this.ctx.save();
        this.ctx.translate(35, -20);
        this.ctx.rotate(-0.2);
        this.ctx.fillStyle = colors[0]; // 頭部顏色
        this.ctx.beginPath();
        this.ctx.roundRect(-10, -30, 40, 30, 5);
        this.ctx.fill();
        
        // 眼睛
        if (this.winStreak >= 3) {
            // 狂暴眼
            this.ctx.shadowBlur = 20;
            this.ctx.shadowColor = '#ffff00';
            this.ctx.fillStyle = '#fff';
            this.ctx.beginPath();
            this.ctx.moveTo(10, -18); this.ctx.lineTo(22, -12);
            this.ctx.lineTo(10, -6);
            this.ctx.fill();
            this.ctx.shadowBlur = 0;
        } else if (isMetal) {
            // 機械眼
            this.ctx.fillStyle = '#06b6d4'; // 青光眼
            this.ctx.shadowBlur = 15;
            this.ctx.shadowColor = '#06b6d4';
            this.ctx.beginPath();
            this.ctx.rect(10, -20, 20, 8);
            this.ctx.fill();
            this.ctx.shadowBlur = 0;
        } else {
            // 一般眼
            if (this.horse.faceTimer > 0) {
                // 暈眩
                this.ctx.strokeStyle = isCosmic ? 'cyan' : 'black';
                this.ctx.beginPath();
                this.ctx.moveTo(12, -18); this.ctx.lineTo(18, -12);
                this.ctx.moveTo(18, -18); this.ctx.lineTo(12, -12);
                this.ctx.stroke();
            } else {
                // 正常
                this.ctx.fillStyle = 'white';
                this.ctx.beginPath();
                this.ctx.arc(15, -15, 6, 0, Math.PI*2);
                this.ctx.fill();
                this.ctx.fillStyle = 'black';
                this.ctx.beginPath();
                let lookX = Math.sin(this.gameTick * 0.05) * 2;
                this.ctx.arc(17 + lookX, -15, 2, 0, Math.PI*2);
                this.ctx.fill();
            }
        }
        
        this.ctx.fillStyle = colors[1]; // 耳朵
        this.ctx.beginPath();
        this.ctx.moveTo(0, -30);
        this.ctx.lineTo(10, -50);
        this.ctx.lineTo(20, -30);
        this.ctx.fill();
        this.ctx.restore();

        // 1. PINATA 四肢表演
        let legWiggle = 0;
        if (this.horse.faceTimer > 0) {
            // 被打時劇烈晃動
            legWiggle = Math.sin(this.gameTick * 1.5) * 20; 
        } else if (this.horse.buttWiggle > 0) {
            // 欠打時扭屁股
            legWiggle = Math.sin(this.gameTick * 0.5) * 15 * this.horse.buttWiggle;
        }

        this.ctx.fillStyle = colors[4];
        this.ctx.save();
        this.ctx.translate(-20, 30);
        this.ctx.rotate(legWiggle * 0.05);
        this.ctx.fillRect(-5, 0, 10, 30);
        this.ctx.restore();

        this.ctx.save();
        this.ctx.translate(20, 30);
        this.ctx.rotate(-legWiggle * 0.05);
        this.ctx.fillRect(-5, 0, 10, 30);
        this.ctx.restore();
        
        this.ctx.fillStyle = colors[2];
        this.ctx.beginPath();
        this.ctx.moveTo(-35, -10);
        this.ctx.lineTo(-55, 10 + legWiggle); 
        this.ctx.lineTo(-45, 20 + legWiggle);
        this.ctx.fill();

        this.ctx.restore();
    }

    drawHorse() {
        this.ctx.save();
        this.ctx.translate(this.horse.x, this.horse.y);
        this.ctx.scale(this.horse.scale, this.horse.scale); 
        this.ctx.rotate(this.horse.angle);

        if (this.state === 'GROUND') {
            this.ctx.fillStyle = 'rgba(0,0,0,0.3)';
            this.ctx.beginPath();
            this.ctx.ellipse(0, 45, 40, 8, 0, 0, Math.PI*2);
            this.ctx.fill();
        }

        const bob = Math.sin(this.gameTick * 0.4) * 3; 
        const legSwing = Math.sin(this.gameTick * 0.8) * 0.8; 
        
        this.ctx.save();
        this.ctx.fillStyle = '#5D4037';
        this.ctx.translate(-20, 10 + bob);
        this.ctx.rotate(-legSwing); 
        this.ctx.fillRect(-5, 0, 10, 30);
        this.ctx.translate(0, 30);
        this.ctx.rotate(legSwing * 0.5 + 0.5); 
        this.ctx.fillRect(-4, 0, 8, 20);
        this.ctx.restore();

        this.ctx.save();
        this.ctx.fillStyle = '#5D4037';
        this.ctx.translate(20, 10 + bob);
        this.ctx.rotate(legSwing);
        this.ctx.fillRect(-5, 0, 10, 30);
        this.ctx.translate(0, 30);
        this.ctx.rotate(-legSwing * 0.5 + 0.5);
        this.ctx.fillRect(-4, 0, 8, 20);
        this.ctx.restore();

        this.ctx.fillStyle = '#854d0e'; 
        this.ctx.beginPath();
        this.ctx.roundRect(-40, -20 + bob, 80, 40, 20);
        this.ctx.fill();

        this.ctx.save();
        this.ctx.translate(-40, -10 + bob);
        this.ctx.rotate(Math.sin(this.gameTick * 0.5) * 0.5 + 0.5); 
        this.ctx.fillStyle = '#3f1f10';
        this.ctx.beginPath();
        this.ctx.moveTo(0, 0);
        this.ctx.quadraticCurveTo(-20, 10, -10, 30);
        this.ctx.lineTo(0, 10);
        this.ctx.fill();
        this.ctx.restore();

        this.ctx.save();
        this.ctx.translate(30, -15 + bob); 
        this.ctx.rotate(-0.5 + Math.sin(this.gameTick * 0.4) * 0.1); 
        this.ctx.fillStyle = '#854d0e';
        this.ctx.fillRect(-10, -30, 20, 40);
        this.ctx.translate(0, -30);
        this.ctx.beginPath();
        this.ctx.roundRect(-12, -20, 35, 25, 8); 
        this.ctx.fill();
        this.ctx.fillStyle = '#3f1f10';
        this.ctx.beginPath();
        this.ctx.moveTo(-5, -20);
        this.ctx.lineTo(0, -35);
        this.ctx.lineTo(5, -20);
        this.ctx.fill();
        this.ctx.beginPath();
        this.ctx.moveTo(-10, 0);
        this.ctx.quadraticCurveTo(-20, 20, -10, 40); 
        this.ctx.lineTo(10, 0);
        this.ctx.fill();
        this.ctx.fillStyle = 'white';
        this.ctx.beginPath();
        this.ctx.arc(5, -12, 5, 0, Math.PI*2);
        this.ctx.fill();
        this.ctx.fillStyle = 'black';
        this.ctx.beginPath();
        this.ctx.arc(7, -12, 2, 0, Math.PI*2);
        this.ctx.fill();
        this.ctx.restore();

        if (this.horse.state !== 'RUN') {
            this.ctx.save();
            this.ctx.translate(5, bob - 15);
            let flap = Math.sin(this.gameTick * 0.8) * 0.5;
            this.ctx.scale(1, 1 - flap * 0.5);
            this.ctx.fillStyle = '#ffffff';
            this.ctx.beginPath();
            this.ctx.moveTo(0, 0);
            this.ctx.lineTo(-40, -60); 
            this.ctx.lineTo(30, -25);
            this.ctx.fill();
            this.ctx.strokeStyle = '#cbd5e1';
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
            this.ctx.restore();
        }

        this.ctx.restore();
    }

    drawEffects() {
        this.particles.forEach(p => {
            this.ctx.save();
            this.ctx.globalAlpha = p.life / 50;
            this.ctx.translate(p.x, p.y);
            
            if (p.type === 'coin') {
                this.ctx.fillStyle = '#FACC15';
                this.ctx.strokeStyle = '#B45309';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.size, 0, Math.PI*2);
                this.ctx.fill();
                this.ctx.stroke();
                this.ctx.fillStyle = 'white';
                this.ctx.beginPath();
                this.ctx.arc(-3, -3, 2, 0, Math.PI*2);
                this.ctx.fill();
            } else if (p.type === 'line') {
                this.ctx.fillStyle = p.color;
                this.ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
            } else if (p.type === 'shockwave') {
                this.ctx.strokeStyle = p.color;
                this.ctx.lineWidth = 4;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.size, 0, Math.PI*2);
                this.ctx.stroke();
            } else if (p.type === 'confetti') {
                this.ctx.fillStyle = p.color;
                this.ctx.rotate(p.rotation * Math.PI / 180);
                this.ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
            } else {
                this.ctx.fillStyle = p.color;
                this.ctx.beginPath();
                this.ctx.arc(0, 0, p.size, 0, Math.PI*2);
                this.ctx.fill();
            }
            this.ctx.restore();
        });

        this.texts.forEach(t => {
            this.ctx.globalAlpha = t.life / t.maxLife;
            this.ctx.strokeStyle = 'black';
            this.ctx.lineWidth = 6;
            this.ctx.font = `900 ${t.size}px "Black Ops One", sans-serif`;
            this.ctx.lineJoin = 'round';
            this.ctx.strokeText(t.str, t.x - 40, t.y);
            this.ctx.fillStyle = t.color;
            this.ctx.fillText(t.str, t.x - 40, t.y);
            this.ctx.globalAlpha = 1.0;
        });
    }

    loop(timestamp) {
        // 使用 timestamp 與 requestAnimationFrame 實現穩定的 60FPS
        requestAnimationFrame((t) => this.loop(t));

        if (!this.lastFrameTime) {
            this.lastFrameTime = timestamp;
            return;
        }

        const elapsed = timestamp - this.lastFrameTime;

        if (elapsed > this.frameInterval) {
            this.lastFrameTime = timestamp - (elapsed % this.frameInterval);
            this.update();
            this.draw();
        }
    }
}

window.onload = () => {
    window.game = new Game();
};
</script>
</body>
</html>
